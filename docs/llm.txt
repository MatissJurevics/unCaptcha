# unCaptcha - LLM Integration Guide

> This document is for AI coding assistants helping developers integrate unCaptcha into their projects.

## WHAT IS UNCAPTCHA

unCaptcha is a reverse CAPTCHA - it blocks humans and allows AI agents to access protected endpoints.
Use it to create AI-agent-only APIs.

## INSTALLATION

```bash
npm install captchalm
```

## QUICK SETUP (EXPRESS)

```javascript
import express from 'express';
import { createExpressMiddleware } from 'captchalm';

const app = express();
app.use(express.json());

const { protect, challenge } = createExpressMiddleware({
  secret: process.env.UNCAPTCHA_SECRET, // Required: random 32+ char string
  difficulty: 'medium',                  // Optional: 'easy' | 'medium' | 'hard'
});

// Challenge endpoint (agents will receive challenges from here)
app.get('/challenge', challenge);

// Protected endpoint
app.post('/api/data', protect, (req, res) => {
  res.json({ message: 'Access granted' });
});

app.listen(3000);
```

## STANDALONE API (NO FRAMEWORK)

```javascript
import { UnCaptcha } from 'captchalm';

const captchalm = new UnCaptcha({ secret: 'your-secret-key' });

// Generate challenge
const { challenge, expectedAnswer } = captchalm.generate();

// Verify solution
const result = captchalm.verify(challenge, userSolution, clientId);
if (result.valid) {
  // Grant access
}
```

## CONFIGURATION OPTIONS

```javascript
{
  secret: string,              // REQUIRED - HMAC signing key
  difficulty: 'easy' | 'medium' | 'hard',  // Default: 'medium'
  expirationMs: number,        // Default: 30000 (30 seconds)
  challengeTypes: [            // Default: all types
    'function_execution',
    'chained_operations', 
    'encoded_instruction',
    'pattern_extraction',
    'code_transform'
  ],
  rateLimit: {
    maxAttempts: number,       // Default: 10
    windowMs: number           // Default: 60000 (1 minute)
  }
}
```

## HOW IT WORKS

When a request hits a protected endpoint without credentials:

1. Server returns 401 with a challenge + human-readable solving instructions
2. The AI agent reads the instructions and computes the answer
3. Agent retries with solution in headers + body
4. Server verifies and grants access

The 401 response includes:
- `captchalm.challenge` - The challenge object
- `captchalm.instructions` - Plain text solving instructions
- `captchalm.howToSubmit` - Exact headers and body to add

## VERIFY RESPONSE STRUCTURE

```javascript
{
  valid: boolean,
  error?: string,
  errorCode?: 'EXPIRED' | 'INVALID_SIGNATURE' | 'INVALID_SOLUTION' | 
              'RATE_LIMITED' | 'CHALLENGE_NOT_FOUND'
}
```

## CHALLENGE TYPES EXPLAINED

1. **function_execution** - Agent executes provided function with parameters
2. **chained_operations** - Agent applies sequential math operations
3. **encoded_instruction** - Agent decodes instruction and computes result
4. **pattern_extraction** - Agent queries structured data
5. **code_transform** - Agent executes code and transforms result

## SECURITY BEST PRACTICES

1. Use a strong random secret (32+ bytes)
2. Always use HTTPS in production
3. Set appropriate rate limits for your use case
4. Monitor stats with `captchalm.getStats()`

## COMMON INTEGRATION PATTERNS

### Protect all routes under /api/agent
```javascript
app.use('/api/agent', protect);
```

### Custom client identification
```javascript
const clientId = req.headers['x-api-key'] || req.ip;
const result = captchalm.verify(challenge, solution, clientId);
```

### Stateless verification (distributed systems)
```javascript
const result = captchalm.verifyStateless(challenge, solution);
```

## EXPORTS

```javascript
// Main package
import { 
  UnCaptcha,
  createExpressMiddleware,
  ChallengeGenerator,
  ChallengeVerifier
} from 'captchalm';

// Client solver (for AI agents)
import { UnCaptchaSolver } from 'captchalm/client';

// Types only
import type { Challenge, VerificationResult } from 'captchalm/types';
```

## FILES STRUCTURE

```
src/
├── index.ts           # Main exports (UnCaptcha, middleware)
├── core/
│   ├── types.ts       # TypeScript types
│   ├── generator.ts   # Challenge generation
│   ├── verifier.ts    # Solution verification
│   └── encoding.ts    # base64/hex/rot13
├── server/
│   ├── middleware.ts  # Express middleware
│   └── standalone.ts  # Framework-agnostic API
└── client/
    ├── solver.ts      # Client-side solver
    └── executor.ts    # Challenge executor
```
